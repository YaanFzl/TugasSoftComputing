{% extends "base.html" %}

{% block title %}Logika Fuzzy - Soft Computing{% endblock %}

{% block content %}
<div class="glass-card">
    <h1><i class="ri-cloud-line"></i> Simulator Logika Fuzzy</h1>
    <p>Eksplorasi penalaran mesin dengan konsep samar menggunakan metode Mamdani dan Sugeno.</p>

    <div style="margin-top: 2rem;">
        <button class="btn-glow" onclick="showTab('mamdani')">Mamdani (Tipping)</button>
        <button class="btn-glow" onclick="showTab('sugeno')"
            style="background: transparent; border: 1px solid var(--secondary-color);">Sugeno (Produksi)</button>
    </div>
</div>

<!-- Mamdani Section -->
<div id="mamdani-section">
    <div class="grid">
        <div class="glass-card">
            <h2><i class="ri-restaurant-line"></i> Masalah Tipping (Mamdani)</h2>
            <p>Hitung jumlah tip berdasarkan Kualitas Makanan dan Pelayanan.</p>

            <div style="margin-top: 2rem;">
                <label>Kualitas Makanan (0-10)</label>
                <input type="range" id="quality" min="0" max="10" step="0.1" value="5"
                    oninput="updateVal('q-val', this.value)">
                <span id="q-val" style="float: right;">5</span>

                <label style="margin-top: 1rem; display: block;">Pelayanan (0-10)</label>
                <input type="range" id="service" min="0" max="10" step="0.1" value="5"
                    oninput="updateVal('s-val', this.value)">
                <span id="s-val" style="float: right;">5</span>

                <button class="btn-glow" style="margin-top: 2rem; width: 100%;" onclick="calculateTip()">Hitung
                    Tip</button>
            </div>
        </div>

        <div class="glass-card" id="mamdani-result-card">
            <h2><i class="ri-lightbulb-line"></i> Hasil</h2>
            <div style="text-align: center; margin-top: 2rem;">
                <h3 style="color: var(--secondary-color); font-size: 2rem;" id="tip-result">0%</h3>
                <p>Rekomendasi Tip</p>
            </div>

            <div
                style="margin-top: 2rem; background: rgba(255,255,255,0.1); height: 20px; border-radius: 10px; overflow: hidden;">
                <div id="tip-bar"
                    style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--secondary-color), var(--primary-color)); transition: width 0.5s ease;">
                </div>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <h2><i class="ri-book-open-line"></i> Teori & Konsep</h2>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTheory(event, 'mf')">Fungsi Keanggotaan</button>
            <button class="tab-btn" onclick="openTheory(event, 'inf')">Metode Inferensi</button>
            <button class="tab-btn" onclick="openTheory(event, 'code')">Contoh Code</button>
        </div>

        <div id="mf" class="tab-content" style="display: block;">
            <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;">
                    <h4>Triangular (Segitiga)</h4>
                    <p style="font-size: 0.9rem;">Didefinisikan oleh 3 parameter {a, b, c}.</p>
                    <p>$$ \mu(x) = \max\left(0, \min\left(\frac{x-a}{b-a}, \frac{c-x}{c-b}\right)\right) $$</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;">
                    <h4>Trapezoidal (Trapesium)</h4>
                    <p style="font-size: 0.9rem;">Didefinisikan oleh 4 parameter {a, b, c, d}.</p>
                    <p>$$ \mu(x) = \max\left(0, \min\left(\frac{x-a}{b-a}, 1, \frac{d-x}{d-c}\right)\right) $$</p>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;">
                    <h4>Gaussian</h4>
                    <p style="font-size: 0.9rem;">Didefinisikan oleh mean (c) dan standar deviasi ($\sigma$).</p>
                    <p>$$ \mu(x) = e^{\frac{-(x-c)^2}{2\sigma^2}} $$</p>
                </div>
            </div>
        </div>

        <div id="inf" class="tab-content" style="display: none;">
            <div class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;">
                    <h4>Mamdani</h4>
                    <p>Metode paling umum. Menggunakan Min-Max. Output berupa himpunan fuzzy.</p>
                    <small style="color: var(--secondary-color);">Cocok untuk: Sistem pakar.</small>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;">
                    <h4>Sugeno</h4>
                    <p>Output berupa konstanta atau persamaan linear (singleton).</p>
                    <small style="color: var(--secondary-color);">Cocok untuk: Kontrol sistem.</small>
                </div>
                <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 10px;">
                    <h4>Tsukamoto</h4>
                    <p>Setiap aturan memiliki output tegas berdasarkan firing strength.</p>
                    <small style="color: var(--secondary-color);">Cocok untuk: Prediksi sederhana.</small>
                </div>
            </div>
        </div>

        <div id="code" class="tab-content" style="display: none;">
            <pre style="background: #1e1e1e; padding: 1rem; border-radius: 5px; overflow-x: auto;"><code class="language-python">import skfuzzy as fuzz
from skfuzzy import control as ctrl

# Antecedent & Consequent
quality = ctrl.Antecedent(np.arange(0, 11, 1), 'quality')
service = ctrl.Antecedent(np.arange(0, 11, 1), 'service')
tip = ctrl.Consequent(np.arange(0, 26, 1), 'tip')

# Membership Functions
quality.automf(3)
service.automf(3)
tip['low'] = fuzz.trimf(tip.universe, [0, 0, 13])
tip['medium'] = fuzz.trimf(tip.universe, [0, 13, 25])
tip['high'] = fuzz.trimf(tip.universe, [13, 25, 25])

# Rules
rule1 = ctrl.Rule(quality['poor'] | service['poor'], tip['low'])
rule2 = ctrl.Rule(service['average'], tip['medium'])
rule3 = ctrl.Rule(service['good'] | quality['good'], tip['high'])

# Simulation
tipping_ctrl = ctrl.ControlSystem([rule1, rule2, rule3])
tipping = ctrl.ControlSystemSimulation(tipping_ctrl)
tipping.input['quality'] = 6.5
tipping.input['service'] = 9.8
tipping.compute()
print(tipping.output['tip'])</code></pre>
        </div>
    </div>
</div>

<!-- Sugeno Section -->
<div id="sugeno-section" style="display: none;">
    <div class="grid">
        <div class="glass-card">
            <h2><i class="ri-building-3-line"></i> Prediksi Produksi (Sugeno)</h2>
            <p>Optimalkan produksi berdasarkan Permintaan dan Stok (Orde-0).</p>
            <div style="margin-top: 2rem;">
                <label>Permintaan (0-5000)</label>
                <input type="range" id="demand" min="0" max="5000" step="100" value="4000"
                    oninput="updateVal('d-val', this.value)">
                <span id="d-val" style="float: right;">4000</span>

                <label style="margin-top: 1rem; display: block;">Stok (0-500)</label>
                <input type="range" id="stock" min="0" max="500" step="10" value="300"
                    oninput="updateVal('s-val', this.value)">
                <span id="s-val" style="float: right;">300</span>

                <button class="btn-glow" style="margin-top: 2rem; width: 100%;" onclick="calculateProduction()">Prediksi
                    Produksi</button>
            </div>
        </div>

        <div class="glass-card" id="sugeno-result-card">
            <h2><i class="ri-bar-chart-line"></i> Prediksi</h2>
            <div style="text-align: center; margin-top: 2rem;">
                <h3 style="color: var(--tertiary-color); font-size: 2rem;" id="prod-result">0 Unit</h3>
                <p>Rekomendasi Produksi</p>
            </div>

            <div style="margin-top: 2rem;">
                <h4>Kekuatan Aturan (Alpha)</h4>
                <ul id="alpha-list"
                    style="list-style: none; padding: 0; margin-top: 1rem; color: rgba(255,255,255,0.7);">
                    <li>Jalankan prediksi untuk melihat detail...</li>
                </ul>
            </div>

            <div style="margin-top: 2rem;">
                <button class="btn-glow" onclick="toggleCalculation()"
                    style="background: transparent; border: 1px solid var(--primary-color); font-size: 0.9rem;">Lihat
                    Perhitungan Manual</button>
                <div id="manual-calc"
                    style="display: none; margin-top: 1rem; background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 10px;">
                    <h4>1. Fuzzifikasi</h4>
                    <p>$$ \mu_{Turun}(x) = \frac{5000-x}{5000} $$</p>
                    <p>$$ \mu_{Naik}(x) = \frac{x}{5000} $$</p>
                    <hr style="border-color: rgba(255,255,255,0.1);">
                    <h4>2. Inferensi (MIN)</h4>
                    <p>Rule 1: IF Turun AND Sedikit THEN z=5000</p>
                    <p>$$ \alpha_1 = \min(\mu_{Turun}, \mu_{Sedikit}) $$</p>
                    <hr style="border-color: rgba(255,255,255,0.1);">
                    <h4>3. Defuzzifikasi (Weighted Avg)</h4>
                    <p>$$ z^* = \frac{\sum \alpha_i z_i}{\sum \alpha_i} $$</p>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <h2><i class="ri-book-open-line"></i> Teori: Metode Sugeno</h2>
        <p>Inferensi fuzzy Sugeno mirip dengan Mamdani tetapi menggunakan fungsi singleton (konstanta) atau linear untuk
            outputnya. Ini efisien secara komputasi dan bekerja dengan baik dengan teknik optimasi dan adaptif.</p>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function showTab(tab) {
        document.getElementById('mamdani-section').style.display = tab === 'mamdani' ? 'block' : 'none';
        document.getElementById('sugeno-section').style.display = tab === 'sugeno' ? 'block' : 'none';
    }

    function updateVal(id, val) {
        document.getElementById(id).innerText = val;
    }

    async function calculateTip() {
        const quality = document.getElementById('quality').value;
        const service = document.getElementById('service').value;

        const response = await fetch('/api/fuzzy/tipping', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                quality: Number(quality),
                service: Number(service)
            })
        });

        const data = await response.json();
        const tip = data.tip.toFixed(2);

        document.getElementById('tip-result').innerText = tip + '%';
        document.getElementById('tip-bar').style.width = (tip / 25 * 100) + '%';

        // Trigger Particle Glow on Result Card
        if (window.highlightElement) {
            window.highlightElement('#mamdani-result-card');
        }
    }

    async function calculateProduction() {
        const demand = document.getElementById('demand').value;
        const stock = document.getElementById('stock').value;

        const response = await fetch('/api/sugeno/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                demand: Number(demand),
                stock: Number(stock)
            })
        });

        const data = await response.json();

        document.getElementById('prod-result').innerText = data.production + ' Unit';

        const list = document.getElementById('alpha-list');
        list.innerHTML = '';
        for (const [rule, alpha] of Object.entries(data.alphas)) {
            const li = document.createElement('li');
            li.innerHTML = `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>${rule}</span>
            <span style="color: var(--secondary-color);">${alpha.toFixed(2)}</span>
        </div>
        <div style="background: rgba(255,255,255,0.1); height: 5px; border-radius: 5px;">
            <div style="width: ${alpha * 100}%; height: 100%; background: var(--tertiary-color);"></div>
        </div>`;
            list.appendChild(li);
        }

        // Trigger Particle Glow on Result Card
        if (window.highlightElement) {
            window.highlightElement('#sugeno-result-card');
        }
    }

    function openTheory(evt, theoryName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(theoryName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    function toggleCalculation() {
        const calc = document.getElementById('manual-calc');
        calc.style.display = calc.style.display === 'none' ? 'block' : 'none';
        // Re-render MathJax
        if (window.MathJax) {
            MathJax.typesetPromise();
        }
    }
</script>
{% endblock %}